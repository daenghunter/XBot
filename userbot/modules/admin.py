import base64
exec(base64.b64decode('IyBDb3B5cmlnaHQgKEMpIDIwMTkgVGhlIFJhcGhpZWxzY2FwZSBDb21wYW55IExMQy4KIwojIExpY2Vuc2VkIHVuZGVyIHRoZSBSYXBoaWVsc2NhcGUgUHVibGljIExpY2Vuc2UsIFZlcnNpb24gMS5jICh0aGUgIkxpY2Vuc2UiKTsKIyB5b3UgbWF5IG5vdCB1c2UgdGhpcyBmaWxlIGV4Y2VwdCBpbiBjb21wbGlhbmNlIHdpdGggdGhlIExpY2Vuc2UuCiIiIgpVc2VyYm90IG1vZHVsZSB0byBoZWxwIHlvdSBtYW5hZ2UgYSBncm91cAoiIiIKCmZyb20gYXN5bmNpbyBpbXBvcnQgc2xlZXAKZnJvbSBvcyBpbXBvcnQgcmVtb3ZlCgpmcm9tIHRlbGV0aG9uLmVycm9ycyBpbXBvcnQgKEJhZFJlcXVlc3RFcnJvciwgQ2hhdEFkbWluUmVxdWlyZWRFcnJvciwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBJbWFnZVByb2Nlc3NGYWlsZWRFcnJvciwgUGhvdG9Dcm9wU2l6ZVNtYWxsRXJyb3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVXNlckFkbWluSW52YWxpZEVycm9yKQpmcm9tIHRlbGV0aG9uLmVycm9ycy5ycGNlcnJvcmxpc3QgaW1wb3J0IChVc2VySWRJbnZhbGlkRXJyb3IsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIE1lc3NhZ2VUb29Mb25nRXJyb3IpCmZyb20gdGVsZXRob24udGwuZnVuY3Rpb25zLmNoYW5uZWxzIGltcG9ydCAoRWRpdEFkbWluUmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBFZGl0QmFubmVkUmVxdWVzdCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBFZGl0UGhvdG9SZXF1ZXN0KQpmcm9tIHRlbGV0aG9uLnRsLmZ1bmN0aW9ucy5tZXNzYWdlcyBpbXBvcnQgVXBkYXRlUGlubmVkTWVzc2FnZVJlcXVlc3QKZnJvbSB0ZWxldGhvbi50bC50eXBlcyBpbXBvcnQgKFBlZXJDaGF0LCBDaGFubmVsUGFydGljaXBhbnRzQWRtaW5zLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQ2hhdEFkbWluUmlnaHRzLCBDaGF0QmFubmVkUmlnaHRzLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgTWVzc2FnZUVudGl0eU1lbnRpb25OYW1lLCBNZXNzYWdlTWVkaWFQaG90bywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIENoYW5uZWxQYXJ0aWNpcGFudHNCb3RzKQoKZnJvbSB1c2VyYm90IGltcG9ydCBCT1RMT0csIEJPVExPR19DSEFUSUQsIENNRF9IRUxQLCBib3QKZnJvbSB1c2VyYm90LmV2ZW50cyBpbXBvcnQgcmVnaXN0ZXIKCiMgPT09PT09PT09PT09PT09PT09PSBDT05TVEFOVCA9PT09PT09PT09PT09PT09PT09ClBQX1RPT19TTU9MID0gImBUaGUgaW1hZ2UgaXMgdG9vIHNtYWxsYCIKUFBfRVJST1IgPSAiYEZhaWx1cmUgd2hpbGUgcHJvY2Vzc2luZyB0aGUgaW1hZ2VgIgpOT19BRE1JTiA9ICJgSSBhbSBub3QgYW4gYWRtaW4hYCIKTk9fUEVSTSA9ICJgSSBkb24ndCBoYXZlIHN1ZmZpY2llbnQgcGVybWlzc2lvbnMhYCIKTk9fU1FMID0gImBSdW5uaW5nIG9uIE5vbi1TUUwgbW9kZSFgIgoKQ0hBVF9QUF9DSEFOR0VEID0gImBDaGF0IFBpY3R1cmUgQ2hhbmdlZGAiCkNIQVRfUFBfRVJST1IgPSAiYFNvbWUgaXNzdWUgd2l0aCB1cGRhdGluZyB0aGUgcGljLGAiIFwKICAgICAgICAgICAgICAgICJgbWF5YmUgY296IEknbSBub3QgYW4gYWRtaW4sYCIgXAogICAgICAgICAgICAgICAgImBvciBkb24ndCBoYXZlIGVub3VnaCByaWdodHMuYCIKSU5WQUxJRF9NRURJQSA9ICJgSW52YWxpZCBFeHRlbnNpb25gIgoKQkFOTkVEX1JJR0hUUyA9IENoYXRCYW5uZWRSaWdodHMoCiAgICB1bnRpbF9kYXRlPU5vbmUsCiAgICB2aWV3X21lc3NhZ2VzPVRydWUsCiAgICBzZW5kX21lc3NhZ2VzPVRydWUsCiAgICBzZW5kX21lZGlhPVRydWUsCiAgICBzZW5kX3N0aWNrZXJzPVRydWUsCiAgICBzZW5kX2dpZnM9VHJ1ZSwKICAgIHNlbmRfZ2FtZXM9VHJ1ZSwKICAgIHNlbmRfaW5saW5lPVRydWUsCiAgICBlbWJlZF9saW5rcz1UcnVlLAopCgpVTkJBTl9SSUdIVFMgPSBDaGF0QmFubmVkUmlnaHRzKAogICAgdW50aWxfZGF0ZT1Ob25lLAogICAgc2VuZF9tZXNzYWdlcz1Ob25lLAogICAgc2VuZF9tZWRpYT1Ob25lLAogICAgc2VuZF9zdGlja2Vycz1Ob25lLAogICAgc2VuZF9naWZzPU5vbmUsCiAgICBzZW5kX2dhbWVzPU5vbmUsCiAgICBzZW5kX2lubGluZT1Ob25lLAogICAgZW1iZWRfbGlua3M9Tm9uZSwKKQoKTVVURV9SSUdIVFMgPSBDaGF0QmFubmVkUmlnaHRzKHVudGlsX2RhdGU9Tm9uZSwgc2VuZF9tZXNzYWdlcz1UcnVlKQoKVU5NVVRFX1JJR0hUUyA9IENoYXRCYW5uZWRSaWdodHModW50aWxfZGF0ZT1Ob25lLCBzZW5kX21lc3NhZ2VzPUZhbHNlKQojID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PQoKCkByZWdpc3RlcihvdXRnb2luZz1UcnVlLCBwYXR0ZXJuPXIiXlwuc2V0Z3BpYyQiKQphc3luYyBkZWYgc2V0X2dyb3VwX3Bob3RvKGdwaWMpOgogICAgIiIiIEZvciAuc2V0Z3BpYyBjb21tYW5kLCBjaGFuZ2VzIHRoZSBwaWN0dXJlIG9mIGEgZ3JvdXAgIiIiCiAgICBpZiBub3QgZ3BpYy5pc19ncm91cDoKICAgICAgICBhd2FpdCBncGljLmVkaXQoImBJIGRvbid0IHRoaW5rIHRoaXMgaXMgYSBncm91cC5gIikKICAgICAgICByZXR1cm4KICAgIHJlcGx5bXNnID0gYXdhaXQgZ3BpYy5nZXRfcmVwbHlfbWVzc2FnZSgpCiAgICBjaGF0ID0gYXdhaXQgZ3BpYy5nZXRfY2hhdCgpCiAgICBhZG1pbiA9IGNoYXQuYWRtaW5fcmlnaHRzCiAgICBjcmVhdG9yID0gY2hhdC5jcmVhdG9yCiAgICBwaG90byA9IE5vbmUKCiAgICBpZiBub3QgYWRtaW4gYW5kIG5vdCBjcmVhdG9yOgogICAgICAgIHJldHVybiBhd2FpdCBncGljLmVkaXQoTk9fQURNSU4pCgogICAgaWYgcmVwbHltc2cgYW5kIHJlcGx5bXNnLm1lZGlhOgogICAgICAgIGlmIGlzaW5zdGFuY2UocmVwbHltc2cubWVkaWEsIE1lc3NhZ2VNZWRpYVBob3RvKToKICAgICAgICAgICAgcGhvdG8gPSBhd2FpdCBncGljLmNsaWVudC5kb3dubG9hZF9tZWRpYShtZXNzYWdlPXJlcGx5bXNnLnBob3RvKQogICAgICAgIGVsaWYgImltYWdlIiBpbiByZXBseW1zZy5tZWRpYS5kb2N1bWVudC5taW1lX3R5cGUuc3BsaXQoJy8nKToKICAgICAgICAgICAgcGhvdG8gPSBhd2FpdCBncGljLmNsaWVudC5kb3dubG9hZF9maWxlKHJlcGx5bXNnLm1lZGlhLmRvY3VtZW50KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF3YWl0IGdwaWMuZWRpdChJTlZBTElEX01FRElBKQoKICAgIGlmIHBob3RvOgogICAgICAgIHRyeToKICAgICAgICAgICAgYXdhaXQgZ3BpYy5jbGllbnQoCiAgICAgICAgICAgICAgICBFZGl0UGhvdG9SZXF1ZXN0KGdwaWMuY2hhdF9pZCwgYXdhaXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZ3BpYy5jbGllbnQudXBsb2FkX2ZpbGUocGhvdG8pKSkKICAgICAgICAgICAgYXdhaXQgZ3BpYy5lZGl0KENIQVRfUFBfQ0hBTkdFRCkKCiAgICAgICAgZXhjZXB0IFBob3RvQ3JvcFNpemVTbWFsbEVycm9yOgogICAgICAgICAgICBhd2FpdCBncGljLmVkaXQoUFBfVE9PX1NNT0wpCiAgICAgICAgZXhjZXB0IEltYWdlUHJvY2Vzc0ZhaWxlZEVycm9yOgogICAgICAgICAgICBhd2FpdCBncGljLmVkaXQoUFBfRVJST1IpCgoKQHJlZ2lzdGVyKG91dGdvaW5nPVRydWUsIHBhdHRlcm49ciJeXC5wcm9tb3RlKD86IHwkKSguKikiKQphc3luYyBkZWYgcHJvbW90ZShwcm9tdCk6CiAgICAiIiIgRm9yIC5wcm9tb3RlIGNvbW1hbmQsIHByb21vdGVzIHRoZSByZXBsaWVkL3RhZ2dlZCBwZXJzb24gIiIiCiAgICAjIEdldCB0YXJnZXRlZCBjaGF0CiAgICBjaGF0ID0gYXdhaXQgcHJvbXQuZ2V0X2NoYXQoKQogICAgIyBHcmFiIGFkbWluIHN0YXR1cyBvciBjcmVhdG9yIGluIGEgY2hhdAogICAgYWRtaW4gPSBjaGF0LmFkbWluX3JpZ2h0cwogICAgY3JlYXRvciA9IGNoYXQuY3JlYXRvcgoKICAgICMgSWYgbm90IGFkbWluIGFuZCBub3QgY3JlYXRvciwgYWxzbyByZXR1cm4KICAgIGlmIG5vdCBhZG1pbiBhbmQgbm90IGNyZWF0b3I6CiAgICAgICAgcmV0dXJuIGF3YWl0IHByb210LmVkaXQoTk9fQURNSU4pCgogICAgbmV3X3JpZ2h0cyA9IENoYXRBZG1pblJpZ2h0cyhhZGRfYWRtaW5zPUZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbnZpdGVfdXNlcnM9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlX2luZm89RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJhbl91c2Vycz1UcnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGVfbWVzc2FnZXM9VHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGluX21lc3NhZ2VzPVRydWUpCgogICAgYXdhaXQgcHJvbXQuZWRpdCgiYFByb21vdGluZy4uLmAiKQogICAgdXNlciwgcmFuayA9IGF3YWl0IGdldF91c2VyX2Zyb21fZXZlbnQocHJvbXQpCiAgICBpZiBub3QgcmFuazoKICAgICAgICByYW5rID0gIkFkbWluaXN0cmF0b3IiICAjIEp1c3QgaW4gY2FzZS4KICAgIGlmIHVzZXI6CiAgICAgICAgcGFzcwogICAgZWxzZToKICAgICAgICByZXR1cm4KCiAgICAjIFRyeSB0byBwcm9tb3RlIGlmIGN1cnJlbnQgdXNlciBpcyBhZG1pbiBvciBjcmVhdG9yCiAgICB0cnk6CiAgICAgICAgYXdhaXQgcHJvbXQuY2xpZW50KAogICAgICAgICAgICBFZGl0QWRtaW5SZXF1ZXN0KHByb210LmNoYXRfaWQsIHVzZXIuaWQsIG5ld19yaWdodHMsIHJhbmspKQogICAgICAgIGF3YWl0IHByb210LmVkaXQoImBQcm9tb3RlZCBTdWNjZXNzZnVsbHkhYCIpCgogICAgIyBJZiBUZWxldGhvbiBzcGl0IEJhZFJlcXVlc3RFcnJvciwgYXNzdW1lCiAgICAjIHdlIGRvbid0IGhhdmUgUHJvbW90ZSBwZXJtaXNzaW9uCiAgICBleGNlcHQgQmFkUmVxdWVzdEVycm9yOgogICAgICAgIHJldHVybiBhd2FpdCBwcm9tdC5lZGl0KE5PX1BFUk0pCgogICAgIyBBbm5vdW5jZSB0byB0aGUgbG9nZ2luZyBncm91cCBpZiB3ZSBoYXZlIHByb21vdGVkIHN1Y2Nlc3NmdWxseQogICAgaWYgQk9UTE9HOgogICAgICAgIGF3YWl0IHByb210LmNsaWVudC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIEJPVExPR19DSEFUSUQsICIjUFJPTU9URVxuIgogICAgICAgICAgICBmIlVTRVI6IFt7dXNlci5maXJzdF9uYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyLmlkfSlcbiIKICAgICAgICAgICAgZiJDSEFUOiB7cHJvbXQuY2hhdC50aXRsZX0oYHtwcm9tdC5jaGF0X2lkfWApIikKCgpAcmVnaXN0ZXIob3V0Z29pbmc9VHJ1ZSwgcGF0dGVybj1yIl5cLmRlbW90ZSg/OiB8JCkoLiopIikKYXN5bmMgZGVmIGRlbW90ZShkbW9kKToKICAgICIiIiBGb3IgLmRlbW90ZSBjb21tYW5kLCBkZW1vdGVzIHRoZSByZXBsaWVkL3RhZ2dlZCBwZXJzb24gIiIiCiAgICAjIEFkbWluIHJpZ2h0IGNoZWNrCiAgICBjaGF0ID0gYXdhaXQgZG1vZC5nZXRfY2hhdCgpCiAgICBhZG1pbiA9IGNoYXQuYWRtaW5fcmlnaHRzCiAgICBjcmVhdG9yID0gY2hhdC5jcmVhdG9yCgogICAgaWYgbm90IGFkbWluIGFuZCBub3QgY3JlYXRvcjoKICAgICAgICByZXR1cm4gYXdhaXQgZG1vZC5lZGl0KE5PX0FETUlOKQoKICAgICMgSWYgcGFzc2luZywgZGVjbGFyZSB0aGF0IHdlJ3JlIGdvaW5nIHRvIGRlbW90ZQogICAgYXdhaXQgZG1vZC5lZGl0KCJgRGVtb3RpbmcuLi5gIikKICAgIHJhbmsgPSAiYWRtZW1lIiAgIyBkdW1teSByYW5rLCBsb2wuCiAgICB1c2VyID0gYXdhaXQgZ2V0X3VzZXJfZnJvbV9ldmVudChkbW9kKQogICAgdXNlciA9IHVzZXJbMF0KICAgIGlmIHVzZXI6CiAgICAgICAgcGFzcwogICAgZWxzZToKICAgICAgICByZXR1cm4KCiAgICAjIE5ldyByaWdodHMgYWZ0ZXIgZGVtb3Rpb24KICAgIG5ld3JpZ2h0cyA9IENoYXRBZG1pblJpZ2h0cyhhZGRfYWRtaW5zPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaW52aXRlX3VzZXJzPU5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hhbmdlX2luZm89Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiYW5fdXNlcnM9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBkZWxldGVfbWVzc2FnZXM9Tm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaW5fbWVzc2FnZXM9Tm9uZSkKICAgICMgRWRpdCBBZG1pbiBQZXJtaXNzaW9uCiAgICB0cnk6CiAgICAgICAgYXdhaXQgZG1vZC5jbGllbnQoCiAgICAgICAgICAgIEVkaXRBZG1pblJlcXVlc3QoZG1vZC5jaGF0X2lkLCB1c2VyLmlkLCBuZXdyaWdodHMsIHJhbmspKQoKICAgICMgSWYgd2UgY2F0Y2ggQmFkUmVxdWVzdEVycm9yIGZyb20gVGVsZXRob24KICAgICMgQXNzdW1lIHdlIGRvbid0IGhhdmUgcGVybWlzc2lvbiB0byBkZW1vdGUKICAgIGV4Y2VwdCBCYWRSZXF1ZXN0RXJyb3I6CiAgICAgICAgcmV0dXJuIGF3YWl0IGRtb2QuZWRpdChOT19QRVJNKQogICAgYXdhaXQgZG1vZC5lZGl0KCJgRGVtb3RlZCBTdWNjZXNzZnVsbHkhYCIpCgogICAgIyBBbm5vdW5jZSB0byB0aGUgbG9nZ2luZyBncm91cCBpZiB3ZSBoYXZlIGRlbW90ZWQgc3VjY2Vzc2Z1bGx5CiAgICBpZiBCT1RMT0c6CiAgICAgICAgYXdhaXQgZG1vZC5jbGllbnQuc2VuZF9tZXNzYWdlKAogICAgICAgICAgICBCT1RMT0dfQ0hBVElELCAiI0RFTU9URVxuIgogICAgICAgICAgICBmIlVTRVI6IFt7dXNlci5maXJzdF9uYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyLmlkfSlcbiIKICAgICAgICAgICAgZiJDSEFUOiB7ZG1vZC5jaGF0LnRpdGxlfShge2Rtb2QuY2hhdF9pZH1gKSIpCgoKQHJlZ2lzdGVyKG91dGdvaW5nPVRydWUsIHBhdHRlcm49ciJeXC5iYW4oPzogfCQpKC4qKSIpCmFzeW5jIGRlZiBiYW4oYm9uKToKICAgICIiIiBGb3IgLmJhbiBjb21tYW5kLCBiYW5zIHRoZSByZXBsaWVkL3RhZ2dlZCBwZXJzb24gIiIiCiAgICAjIEhlcmUgbGF5aW5nIHRoZSBzYW5pdHkgY2hlY2sKICAgIGNoYXQgPSBhd2FpdCBib24uZ2V0X2NoYXQoKQogICAgYWRtaW4gPSBjaGF0LmFkbWluX3JpZ2h0cwogICAgY3JlYXRvciA9IGNoYXQuY3JlYXRvcgoKICAgICMgV2VsbAogICAgaWYgbm90IGFkbWluIGFuZCBub3QgY3JlYXRvcjoKICAgICAgICByZXR1cm4gYXdhaXQgYm9uLmVkaXQoTk9fQURNSU4pCgogICAgdXNlciwgcmVhc29uID0gYXdhaXQgZ2V0X3VzZXJfZnJvbV9ldmVudChib24pCiAgICBpZiB1c2VyOgogICAgICAgIHBhc3MKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuCgogICAgIyBBbm5vdW5jZSB0aGF0IHdlJ3JlIGdvaW5nIHRvIHdoYWNrIHRoZSBwZXN0CiAgICBhd2FpdCBib24uZWRpdCgiYFdoYWNraW5nIHRoZSBwZXN0IWAiKQoKICAgIHRyeToKICAgICAgICBhd2FpdCBib24uY2xpZW50KEVkaXRCYW5uZWRSZXF1ZXN0KGJvbi5jaGF0X2lkLCB1c2VyLmlkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQkFOTkVEX1JJR0hUUykpCiAgICBleGNlcHQgQmFkUmVxdWVzdEVycm9yOgogICAgICAgIHJldHVybiBhd2FpdCBib24uZWRpdChOT19QRVJNKQogICAgIyBIZWxwcyBiYW4gZ3JvdXAgam9pbiBzcGFtbWVycyBtb3JlIGVhc2lseQogICAgdHJ5OgogICAgICAgIHJlcGx5ID0gYXdhaXQgYm9uLmdldF9yZXBseV9tZXNzYWdlKCkKICAgICAgICBpZiByZXBseToKICAgICAgICAgICAgYXdhaXQgcmVwbHkuZGVsZXRlKCkKICAgIGV4Y2VwdCBCYWRSZXF1ZXN0RXJyb3I6CiAgICAgICAgcmV0dXJuIGF3YWl0IGJvbi5lZGl0KAogICAgICAgICAgICAiYEkgZG9udCBoYXZlIG1lc3NhZ2UgbnVraW5nIHJpZ2h0cyEgQnV0IHN0aWxsIGhlIHdhcyBiYW5uZWQhYCIpCiAgICAjIERlbGV0ZSBtZXNzYWdlIGFuZCB0aGVuIHRlbGwgdGhhdCB0aGUgY29tbWFuZAogICAgIyBpcyBkb25lIGdyYWNlZnVsbHkKICAgICMgU2hvdXQgb3V0IHRoZSBJRCwgc28gdGhhdCBmZWRhZG1pbnMgY2FuIGZiYW4gbGF0ZXIKICAgIGlmIHJlYXNvbjoKICAgICAgICBhd2FpdCBib24uZWRpdChmImB7c3RyKHVzZXIuaWQpfWAgd2FzIGJhbm5lZCAhIVxuUmVhc29uOiB7cmVhc29ufSIpCiAgICBlbHNlOgogICAgICAgIGF3YWl0IGJvbi5lZGl0KGYiYHtzdHIodXNlci5pZCl9YCB3YXMgYmFubmVkICEhIikKICAgICMgQW5ub3VuY2UgdG8gdGhlIGxvZ2dpbmcgZ3JvdXAgaWYgd2UgaGF2ZSBiYW5uZWQgdGhlIHBlcnNvbgogICAgIyBzdWNjZXNzZnVsbHkhCiAgICBpZiBCT1RMT0c6CiAgICAgICAgYXdhaXQgYm9uLmNsaWVudC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIEJPVExPR19DSEFUSUQsICIjQkFOXG4iCiAgICAgICAgICAgIGYiVVNFUjogW3t1c2VyLmZpcnN0X25hbWV9XSh0ZzovL3VzZXI/aWQ9e3VzZXIuaWR9KVxuIgogICAgICAgICAgICBmIkNIQVQ6IHtib24uY2hhdC50aXRsZX0oYHtib24uY2hhdF9pZH1gKSIpCgoKQHJlZ2lzdGVyKG91dGdvaW5nPVRydWUsIHBhdHRlcm49ciJeXC51bmJhbig/OiB8JCkoLiopIikKYXN5bmMgZGVmIG5vdGhhbm9zKHVuYm9uKToKICAgICIiIiBGb3IgLnVuYmFuIGNvbW1hbmQsIHVuYmFucyB0aGUgcmVwbGllZC90YWdnZWQgcGVyc29uICIiIgogICAgIyBIZXJlIGxheWluZyB0aGUgc2FuaXR5IGNoZWNrCiAgICBjaGF0ID0gYXdhaXQgdW5ib24uZ2V0X2NoYXQoKQogICAgYWRtaW4gPSBjaGF0LmFkbWluX3JpZ2h0cwogICAgY3JlYXRvciA9IGNoYXQuY3JlYXRvcgoKICAgICMgV2VsbAogICAgaWYgbm90IGFkbWluIGFuZCBub3QgY3JlYXRvcjoKICAgICAgICByZXR1cm4gYXdhaXQgdW5ib24uZWRpdChOT19BRE1JTikKCiAgICAjIElmIGV2ZXJ5dGhpbmcgZ29lcyB3ZWxsLi4uCiAgICBhd2FpdCB1bmJvbi5lZGl0KCJgVW5iYW5uaW5nLi4uYCIpCgogICAgdXNlciA9IGF3YWl0IGdldF91c2VyX2Zyb21fZXZlbnQodW5ib24pCiAgICB1c2VyID0gdXNlclswXQogICAgaWYgdXNlcjoKICAgICAgICBwYXNzCiAgICBlbHNlOgogICAgICAgIHJldHVybgoKICAgIHRyeToKICAgICAgICBhd2FpdCB1bmJvbi5jbGllbnQoCiAgICAgICAgICAgIEVkaXRCYW5uZWRSZXF1ZXN0KHVuYm9uLmNoYXRfaWQsIHVzZXIuaWQsIFVOQkFOX1JJR0hUUykpCiAgICAgICAgYXdhaXQgdW5ib24uZWRpdCgiYGBgVW5iYW5uZWQgU3VjY2Vzc2Z1bGx5YGBgIikKCiAgICAgICAgaWYgQk9UTE9HOgogICAgICAgICAgICBhd2FpdCB1bmJvbi5jbGllbnQuc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgQk9UTE9HX0NIQVRJRCwgIiNVTkJBTlxuIgogICAgICAgICAgICAgICAgZiJVU0VSOiBbe3VzZXIuZmlyc3RfbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlci5pZH0pXG4iCiAgICAgICAgICAgICAgICBmIkNIQVQ6IHt1bmJvbi5jaGF0LnRpdGxlfShge3VuYm9uLmNoYXRfaWR9YCkiKQogICAgZXhjZXB0IFVzZXJJZEludmFsaWRFcnJvcjoKICAgICAgICBhd2FpdCB1bmJvbi5lZGl0KCJgVWggb2ggbXkgdW5iYW4gbG9naWMgYnJva2UhYCIpCgoKQHJlZ2lzdGVyKG91dGdvaW5nPVRydWUsIHBhdHRlcm49ciJeXC5tdXRlKD86IHwkKSguKikiKQphc3luYyBkZWYgc3BpZGVyKHNwZHIpOgogICAgIiIiCiAgICBUaGlzIGZ1bmN0aW9uIGlzIGJhc2ljYWxseSBtdXRpbmcgcGVlcHMKICAgICIiIgogICAgIyBDaGVjayBpZiB0aGUgZnVuY3Rpb24gcnVubmluZyB1bmRlciBTUUwgbW9kZQogICAgdHJ5OgogICAgICAgIGZyb20gdXNlcmJvdC5tb2R1bGVzLnNxbF9oZWxwZXIuc3BhbV9tdXRlX3NxbCBpbXBvcnQgbXV0ZQogICAgZXhjZXB0IEF0dHJpYnV0ZUVycm9yOgogICAgICAgIHJldHVybiBhd2FpdCBzcGRyLmVkaXQoTk9fU1FMKQoKICAgICMgQWRtaW4gb3IgY3JlYXRvciBjaGVjawogICAgY2hhdCA9IGF3YWl0IHNwZHIuZ2V0X2NoYXQoKQogICAgYWRtaW4gPSBjaGF0LmFkbWluX3JpZ2h0cwogICAgY3JlYXRvciA9IGNoYXQuY3JlYXRvcgoKICAgICMgSWYgbm90IGFkbWluIGFuZCBub3QgY3JlYXRvciwgcmV0dXJuCiAgICBpZiBub3QgYWRtaW4gYW5kIG5vdCBjcmVhdG9yOgogICAgICAgIHJldHVybiBhd2FpdCBzcGRyLmVkaXQoTk9fQURNSU4pCgogICAgdXNlciwgcmVhc29uID0gYXdhaXQgZ2V0X3VzZXJfZnJvbV9ldmVudChzcGRyKQogICAgaWYgdXNlcjoKICAgICAgICBwYXNzCiAgICBlbHNlOgogICAgICAgIHJldHVybgoKICAgIHNlbGZfdXNlciA9IGF3YWl0IHNwZHIuY2xpZW50LmdldF9tZSgpCgogICAgaWYgdXNlci5pZCA9PSBzZWxmX3VzZXIuaWQ6CiAgICAgICAgcmV0dXJuIGF3YWl0IHNwZHIuZWRpdCgKICAgICAgICAgICAgImBIYW5kcyB0b28gc2hvcnQsIGNhbid0IGR1Y3QgdGFwZSBteXNlbGYuLi5cbijjg5jvvaVf772lKeODmOKUs+KUgeKUs2AiKQoKICAgICMgSWYgZXZlcnl0aGluZyBnb2VzIHdlbGwsIGRvIGFubm91bmNpbmcgYW5kIG11dGUKICAgIGF3YWl0IHNwZHIuZWRpdCgiYEdldHMgYSB0YXBlIWAiKQogICAgaWYgbXV0ZShzcGRyLmNoYXRfaWQsIHVzZXIuaWQpIGlzIEZhbHNlOgogICAgICAgIHJldHVybiBhd2FpdCBzcGRyLmVkaXQoJ2BFcnJvciEgVXNlciBwcm9iYWJseSBhbHJlYWR5IG11dGVkLmAnKQogICAgZWxzZToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGF3YWl0IHNwZHIuY2xpZW50KAogICAgICAgICAgICAgICAgRWRpdEJhbm5lZFJlcXVlc3Qoc3Bkci5jaGF0X2lkLCB1c2VyLmlkLCBNVVRFX1JJR0hUUykpCgogICAgICAgICAgICAjIEFubm91bmNlIHRoYXQgdGhlIGZ1bmN0aW9uIGlzIGRvbmUKICAgICAgICAgICAgaWYgcmVhc29uOgogICAgICAgICAgICAgICAgYXdhaXQgc3Bkci5lZGl0KGYiYFNhZmVseSB0YXBlZCAhIWBcblJlYXNvbjoge3JlYXNvbn0iKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYXdhaXQgc3Bkci5lZGl0KCJgU2FmZWx5IHRhcGVkICEhYCIpCgogICAgICAgICAgICAjIEFubm91bmNlIHRvIGxvZ2dpbmcgZ3JvdXAKICAgICAgICAgICAgaWYgQk9UTE9HOgogICAgICAgICAgICAgICAgYXdhaXQgc3Bkci5jbGllbnQuc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgICAgIEJPVExPR19DSEFUSUQsICIjTVVURVxuIgogICAgICAgICAgICAgICAgICAgIGYiVVNFUjogW3t1c2VyLmZpcnN0X25hbWV9XSh0ZzovL3VzZXI/aWQ9e3VzZXIuaWR9KVxuIgogICAgICAgICAgICAgICAgICAgIGYiQ0hBVDoge3NwZHIuY2hhdC50aXRsZX0oYHtzcGRyLmNoYXRfaWR9YCkiKQogICAgICAgIGV4Y2VwdCBVc2VySWRJbnZhbGlkRXJyb3I6CiAgICAgICAgICAgIHJldHVybiBhd2FpdCBzcGRyLmVkaXQoImBVaCBvaCBteSBtdXRlIGxvZ2ljIGJyb2tlIWAiKQoKCkByZWdpc3RlcihvdXRnb2luZz1UcnVlLCBwYXR0ZXJuPXIiXlwudW5tdXRlKD86IHwkKSguKikiKQphc3luYyBkZWYgdW5tb290KHVubW90KToKICAgICIiIiBGb3IgLnVubXV0ZSBjb21tYW5kLCB1bm11dGUgdGhlIHJlcGxpZWQvdGFnZ2VkIHBlcnNvbiAiIiIKICAgICMgQWRtaW4gb3IgY3JlYXRvciBjaGVjawogICAgY2hhdCA9IGF3YWl0IHVubW90LmdldF9jaGF0KCkKICAgIGFkbWluID0gY2hhdC5hZG1pbl9yaWdodHMKICAgIGNyZWF0b3IgPSBjaGF0LmNyZWF0b3IKCiAgICAjIElmIG5vdCBhZG1pbiBhbmQgbm90IGNyZWF0b3IsIHJldHVybgogICAgaWYgbm90IGFkbWluIGFuZCBub3QgY3JlYXRvcjoKICAgICAgICByZXR1cm4gYXdhaXQgdW5tb3QuZWRpdChOT19BRE1JTikKCiAgICAjIENoZWNrIGlmIHRoZSBmdW5jdGlvbiBydW5uaW5nIHVuZGVyIFNRTCBtb2RlCiAgICB0cnk6CiAgICAgICAgZnJvbSB1c2VyYm90Lm1vZHVsZXMuc3FsX2hlbHBlci5zcGFtX211dGVfc3FsIGltcG9ydCB1bm11dGUKICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICByZXR1cm4gYXdhaXQgdW5tb3QuZWRpdChOT19TUUwpCgogICAgIyBJZiBhZG1pbiBvciBjcmVhdG9yLCBpbmZvcm0gdGhlIHVzZXIgYW5kIHN0YXJ0IHVubXV0aW5nCiAgICBhd2FpdCB1bm1vdC5lZGl0KCdgYGBVbm11dGluZy4uLmBgYCcpCiAgICB1c2VyID0gYXdhaXQgZ2V0X3VzZXJfZnJvbV9ldmVudCh1bm1vdCkKICAgIHVzZXIgPSB1c2VyWzBdCiAgICBpZiB1c2VyOgogICAgICAgIHBhc3MKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuCgogICAgaWYgdW5tdXRlKHVubW90LmNoYXRfaWQsIHVzZXIuaWQpIGlzIEZhbHNlOgogICAgICAgIHJldHVybiBhd2FpdCB1bm1vdC5lZGl0KCJgRXJyb3IhIFVzZXIgcHJvYmFibHkgYWxyZWFkeSB1bm11dGVkLmAiKQogICAgZWxzZToKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhd2FpdCB1bm1vdC5jbGllbnQoCiAgICAgICAgICAgICAgICBFZGl0QmFubmVkUmVxdWVzdCh1bm1vdC5jaGF0X2lkLCB1c2VyLmlkLCBVTkJBTl9SSUdIVFMpKQogICAgICAgICAgICBhd2FpdCB1bm1vdC5lZGl0KCJgYGBVbm11dGVkIFN1Y2Nlc3NmdWxseWBgYCIpCiAgICAgICAgZXhjZXB0IFVzZXJJZEludmFsaWRFcnJvcjoKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHVubW90LmVkaXQoImBVaCBvaCBteSB1bm11dGUgbG9naWMgYnJva2UhYCIpCgogICAgICAgIGlmIEJPVExPRzoKICAgICAgICAgICAgYXdhaXQgdW5tb3QuY2xpZW50LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgIEJPVExPR19DSEFUSUQsICIjVU5NVVRFXG4iCiAgICAgICAgICAgICAgICBmIlVTRVI6IFt7dXNlci5maXJzdF9uYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyLmlkfSlcbiIKICAgICAgICAgICAgICAgIGYiQ0hBVDoge3VubW90LmNoYXQudGl0bGV9KGB7dW5tb3QuY2hhdF9pZH1gKSIpCgoKQHJlZ2lzdGVyKGluY29taW5nPVRydWUpCmFzeW5jIGRlZiBtdXRlcihtb290KToKICAgICIiIiBVc2VkIGZvciBkZWxldGluZyB0aGUgbWVzc2FnZXMgb2YgbXV0ZWQgcGVvcGxlICIiIgogICAgdHJ5OgogICAgICAgIGZyb20gdXNlcmJvdC5tb2R1bGVzLnNxbF9oZWxwZXIuc3BhbV9tdXRlX3NxbCBpbXBvcnQgaXNfbXV0ZWQKICAgICAgICBmcm9tIHVzZXJib3QubW9kdWxlcy5zcWxfaGVscGVyLmdtdXRlX3NxbCBpbXBvcnQgaXNfZ211dGVkCiAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgcmV0dXJuCiAgICBtdXRlZCA9IGlzX211dGVkKG1vb3QuY2hhdF9pZCkKICAgIGdtdXRlZCA9IGlzX2dtdXRlZChtb290LnNlbmRlcl9pZCkKICAgIHJpZ2h0cyA9IENoYXRCYW5uZWRSaWdodHMoCiAgICAgICAgdW50aWxfZGF0ZT1Ob25lLAogICAgICAgIHNlbmRfbWVzc2FnZXM9VHJ1ZSwKICAgICAgICBzZW5kX21lZGlhPVRydWUsCiAgICAgICAgc2VuZF9zdGlja2Vycz1UcnVlLAogICAgICAgIHNlbmRfZ2lmcz1UcnVlLAogICAgICAgIHNlbmRfZ2FtZXM9VHJ1ZSwKICAgICAgICBzZW5kX2lubGluZT1UcnVlLAogICAgICAgIGVtYmVkX2xpbmtzPVRydWUsCiAgICApCiAgICBpZiBtdXRlZDoKICAgICAgICBmb3IgaSBpbiBtdXRlZDoKICAgICAgICAgICAgaWYgc3RyKGkuc2VuZGVyKSA9PSBzdHIobW9vdC5zZW5kZXJfaWQpOgogICAgICAgICAgICAgICAgYXdhaXQgbW9vdC5kZWxldGUoKQogICAgICAgICAgICAgICAgYXdhaXQgbW9vdC5jbGllbnQoCiAgICAgICAgICAgICAgICAgICAgRWRpdEJhbm5lZFJlcXVlc3QobW9vdC5jaGF0X2lkLCBtb290LnNlbmRlcl9pZCwgcmlnaHRzKSkKICAgIGZvciBpIGluIGdtdXRlZDoKICAgICAgICBpZiBpLnNlbmRlciA9PSBzdHIobW9vdC5zZW5kZXJfaWQpOgogICAgICAgICAgICBhd2FpdCBtb290LmRlbGV0ZSgpCgoKQHJlZ2lzdGVyKG91dGdvaW5nPVRydWUsIHBhdHRlcm49ciJeXC51bmdtdXRlKD86IHwkKSguKikiKQphc3luYyBkZWYgdW5nbW9vdCh1bl9nbXV0ZSk6CiAgICAiIiIgRm9yIC51bmdtdXRlIGNvbW1hbmQsIHVuZ211dGVzIHRoZSB0YXJnZXQgaW4gdGhlIHVzZXJib3QgIiIiCiAgICAjIEFkbWluIG9yIGNyZWF0b3IgY2hlY2sKICAgIGNoYXQgPSBhd2FpdCB1bl9nbXV0ZS5nZXRfY2hhdCgpCiAgICBhZG1pbiA9IGNoYXQuYWRtaW5fcmlnaHRzCiAgICBjcmVhdG9yID0gY2hhdC5jcmVhdG9yCgogICAgIyBJZiBub3QgYWRtaW4gYW5kIG5vdCBjcmVhdG9yLCByZXR1cm4KICAgIGlmIG5vdCBhZG1pbiBhbmQgbm90IGNyZWF0b3I6CiAgICAgICAgYXdhaXQgdW5fZ211dGUuZWRpdChOT19BRE1JTikKICAgICAgICByZXR1cm4KCiAgICAjIENoZWNrIGlmIHRoZSBmdW5jdGlvbiBydW5uaW5nIHVuZGVyIFNRTCBtb2RlCiAgICB0cnk6CiAgICAgICAgZnJvbSB1c2VyYm90Lm1vZHVsZXMuc3FsX2hlbHBlci5nbXV0ZV9zcWwgaW1wb3J0IHVuZ211dGUKICAgIGV4Y2VwdCBBdHRyaWJ1dGVFcnJvcjoKICAgICAgICBhd2FpdCB1bl9nbXV0ZS5lZGl0KE5PX1NRTCkKICAgICAgICByZXR1cm4KCiAgICB1c2VyID0gYXdhaXQgZ2V0X3VzZXJfZnJvbV9ldmVudCh1bl9nbXV0ZSkKICAgIHVzZXIgPSB1c2VyWzBdCiAgICBpZiB1c2VyOgogICAgICAgIHBhc3MKICAgIGVsc2U6CiAgICAgICAgcmV0dXJuCgogICAgIyBJZiBwYXNzLCBpbmZvcm0gYW5kIHN0YXJ0IHVuZ211dGluZwogICAgYXdhaXQgdW5fZ211dGUuZWRpdCgnYGBgVW5nbXV0aW5nLi4uYGBgJykKCiAgICBpZiB1bmdtdXRlKHVzZXIuaWQpIGlzIEZhbHNlOgogICAgICAgIGF3YWl0IHVuX2dtdXRlLmVkaXQoImBFcnJvciEgVXNlciBwcm9iYWJseSBub3QgZ211dGVkLmAiKQogICAgZWxzZToKICAgICAgICAjIEluZm9ybSBhYm91dCBzdWNjZXNzCiAgICAgICAgYXdhaXQgdW5fZ211dGUuZWRpdCgiYGBgVW5nbXV0ZWQgU3VjY2Vzc2Z1bGx5YGBgIikKICAgICAgICBhd2FpdCBzbGVlcCgzKQogICAgICAgIGF3YWl0IHVuX2dtdXRlLmRlbGV0ZSgpCgogICAgICAgIGlmIEJPVExPRzoKICAgICAgICAgICAgYXdhaXQgdW5fZ211dGUuY2xpZW50LnNlbmRfbWVzc2FnZSgKICAgICAgICAgICAgICAgIEJPVExPR19DSEFUSUQsICIjVU5HTVVURVxuIgogICAgICAgICAgICAgICAgZiJVU0VSOiBbe3VzZXIuZmlyc3RfbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlci5pZH0pXG4iCiAgICAgICAgICAgICAgICBmIkNIQVQ6IHt1bl9nbXV0ZS5jaGF0LnRpdGxlfShge3VuX2dtdXRlLmNoYXRfaWR9YCkiKQoKCkByZWdpc3RlcihvdXRnb2luZz1UcnVlLCBwYXR0ZXJuPXIiXlwuZ211dGUoPzogfCQpKC4qKSIpCmFzeW5jIGRlZiBnc3BpZGVyKGdzcGRyKToKICAgICIiIiBGb3IgLmdtdXRlIGNvbW1hbmQsIGdsb2JhbGx5IG11dGVzIHRoZSByZXBsaWVkL3RhZ2dlZCBwZXJzb24gIiIiCiAgICAjIEFkbWluIG9yIGNyZWF0b3IgY2hlY2sKICAgIGNoYXQgPSBhd2FpdCBnc3Bkci5nZXRfY2hhdCgpCiAgICBhZG1pbiA9IGNoYXQuYWRtaW5fcmlnaHRzCiAgICBjcmVhdG9yID0gY2hhdC5jcmVhdG9yCgogICAgIyBJZiBub3QgYWRtaW4gYW5kIG5vdCBjcmVhdG9yLCByZXR1cm4KICAgIGlmIG5vdCBhZG1pbiBhbmQgbm90IGNyZWF0b3I6CiAgICAgICAgYXdhaXQgZ3NwZHIuZWRpdChOT19BRE1JTikKICAgICAgICByZXR1cm4KCiAgICAjIENoZWNrIGlmIHRoZSBmdW5jdGlvbiBydW5uaW5nIHVuZGVyIFNRTCBtb2RlCiAgICB0cnk6CiAgICAgICAgZnJvbSB1c2VyYm90Lm1vZHVsZXMuc3FsX2hlbHBlci5nbXV0ZV9zcWwgaW1wb3J0IGdtdXRlCiAgICBleGNlcHQgQXR0cmlidXRlRXJyb3I6CiAgICAgICAgYXdhaXQgZ3NwZHIuZWRpdChOT19TUUwpCiAgICAgICAgcmV0dXJuCgogICAgdXNlciwgcmVhc29uID0gYXdhaXQgZ2V0X3VzZXJfZnJvbV9ldmVudChnc3BkcikKICAgIGlmIHVzZXI6CiAgICAgICAgcGFzcwogICAgZWxzZToKICAgICAgICByZXR1cm4KCiAgICAjIElmIHBhc3MsIGluZm9ybSBhbmQgc3RhcnQgZ211dGluZwogICAgYXdhaXQgZ3NwZHIuZWRpdCgiYEdyYWJzIGEgaHVnZSwgc3RpY2t5IGR1Y3QgdGFwZSFgIikKICAgIGlmIGdtdXRlKHVzZXIuaWQpIGlzIEZhbHNlOgogICAgICAgIGF3YWl0IGdzcGRyLmVkaXQoCiAgICAgICAgICAgICdgRXJyb3IhIFVzZXIgcHJvYmFibHkgYWxyZWFkeSBnbXV0ZWQuXG5SZS1yb2xscyB0aGUgdGFwZS5gJykKICAgIGVsc2U6CiAgICAgICAgaWYgcmVhc29uOgogICAgICAgICAgICBhd2FpdCBnc3Bkci5lZGl0KGYiYEdsb2JhbGx5IHRhcGVkIWBcblJlYXNvbjoge3JlYXNvbn0iKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF3YWl0IGdzcGRyLmVkaXQoImBHbG9iYWxseSB0YXBlZCFgIikKCiAgICAgICAgaWYgQk9UTE9HOgogICAgICAgICAgICBhd2FpdCBnc3Bkci5jbGllbnQuc2VuZF9tZXNzYWdlKAogICAgICAgICAgICAgICAgQk9UTE9HX0NIQVRJRCwgIiNHTVVURVxuIgogICAgICAgICAgICAgICAgZiJVU0VSOiBbe3VzZXIuZmlyc3RfbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlci5pZH0pXG4iCiAgICAgICAgICAgICAgICBmIkNIQVQ6IHtnc3Bkci5jaGF0LnRpdGxlfShge2dzcGRyLmNoYXRfaWR9YCkiKQoKCkByZWdpc3RlcihvdXRnb2luZz1UcnVlLCBwYXR0ZXJuPXIiXlwuem9tYmllcyg/OiB8JCkoLiopIiwgZ3JvdXBzX29ubHk9RmFsc2UpCmFzeW5jIGRlZiBybV9kZWxldGVkYWNjKHNob3cpOgogICAgIiIiIEZvciAuem9tYmllcyBjb21tYW5kLCBsaXN0IGFsbCB0aGUgZ2hvc3QvZGVsZXRlZC96b21iaWUgYWNjb3VudHMgaW4gYSBjaGF0LiAiIiIKCiAgICBjb24gPSBzaG93LnBhdHRlcm5fbWF0Y2guZ3JvdXAoMSkubG93ZXIoKQogICAgZGVsX3UgPSAwCiAgICBkZWxfc3RhdHVzID0gImBObyBkZWxldGVkIGFjY291bnRzIGZvdW5kLCBHcm91cCBpcyBjbGVhbmAiCgogICAgaWYgY29uICE9ICJjbGVhbiI6CiAgICAgICAgYXdhaXQgc2hvdy5lZGl0KCJgU2VhcmNoaW5nIGZvciBnaG9zdC9kZWxldGVkL3pvbWJpZSBhY2NvdW50cy4uLmAiKQogICAgICAgIGFzeW5jIGZvciB1c2VyIGluIHNob3cuY2xpZW50Lml0ZXJfcGFydGljaXBhbnRzKHNob3cuY2hhdF9pZCk6CgogICAgICAgICAgICBpZiB1c2VyLmRlbGV0ZWQ6CiAgICAgICAgICAgICAgICBkZWxfdSArPSAxCiAgICAgICAgICAgICAgICBhd2FpdCBzbGVlcCgxKQogICAgICAgIGlmIGRlbF91ID4gMDoKICAgICAgICAgICAgZGVsX3N0YXR1cyA9ICgKICAgICAgICAgICAgICAgIGYiYEZvdW5kYCAqKntkZWxfdX0qKiBgZ2hvc3QvZGVsZXRlZC96b21iaWUgYWNjb3VudChzKSBpbiB0aGlzIGdyb3VwLCIKICAgICAgICAgICAgICAgICJcbmNsZWFuIHRoZW0gYnkgdXNpbmcgLnpvbWJpZXMgY2xlYW5gIikKICAgICAgICByZXR1cm4gYXdhaXQgc2hvdy5lZGl0KGRlbF9zdGF0dXMpCgogICAgIyBIZXJlIGxheWluZyB0aGUgc2FuaXR5IGNoZWNrCiAgICBjaGF0ID0gYXdhaXQgc2hvdy5nZXRfY2hhdCgpCiAgICBhZG1pbiA9IGNoYXQuYWRtaW5fcmlnaHRzCiAgICBjcmVhdG9yID0gY2hhdC5jcmVhdG9yCgogICAgIyBXZWxsCiAgICBpZiBub3QgYWRtaW4gYW5kIG5vdCBjcmVhdG9yOgogICAgICAgIHJldHVybiBhd2FpdCBzaG93LmVkaXQoImBJIGFtIG5vdCBhbiBhZG1pbiBoZXJlIWAiKQoKICAgIGF3YWl0IHNob3cuZWRpdCgiYERlbGV0aW5nIGRlbGV0ZWQgYWNjb3VudHMuLi5cbk9oIEkgY2FuIGRvIHRoYXQ/IT8hYCIpCiAgICBkZWxfdSA9IDAKICAgIGRlbF9hID0gMAoKICAgIGFzeW5jIGZvciB1c2VyIGluIHNob3cuY2xpZW50Lml0ZXJfcGFydGljaXBhbnRzKHNob3cuY2hhdF9pZCk6CiAgICAgICAgaWYgdXNlci5kZWxldGVkOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBhd2FpdCBzaG93LmNsaWVudCgKICAgICAgICAgICAgICAgICAgICBFZGl0QmFubmVkUmVxdWVzdChzaG93LmNoYXRfaWQsIHVzZXIuaWQsIEJBTk5FRF9SSUdIVFMpKQogICAgICAgICAgICBleGNlcHQgQ2hhdEFkbWluUmVxdWlyZWRFcnJvcjoKICAgICAgICAgICAgICAgIHJldHVybiBhd2FpdCBzaG93LmVkaXQoImBJIGRvbid0IGhhdmUgYmFuIHJpZ2h0cyBpbiB0aGlzIGdyb3VwYCIpCiAgICAgICAgICAgIGV4Y2VwdCBVc2VyQWRtaW5JbnZhbGlkRXJyb3I6CiAgICAgICAgICAgICAgICBkZWxfdSAtPSAxCiAgICAgICAgICAgICAgICBkZWxfYSArPSAxCiAgICAgICAgICAgIGF3YWl0IHNob3cuY2xpZW50KAogICAgICAgICAgICAgICAgRWRpdEJhbm5lZFJlcXVlc3Qoc2hvdy5jaGF0X2lkLCB1c2VyLmlkLCBVTkJBTl9SSUdIVFMpKQogICAgICAgICAgICBkZWxfdSArPSAxCgogICAgaWYgZGVsX3UgPiAwOgogICAgICAgIGRlbF9zdGF0dXMgPSBmIkNsZWFuZWQgKip7ZGVsX3V9KiogZGVsZXRlZCBhY2NvdW50KHMpIgoKICAgIGlmIGRlbF9hID4gMDoKICAgICAgICBkZWxfc3RhdHVzID0gKGYiQ2xlYW5lZCAqKntkZWxfdX0qKiBkZWxldGVkIGFjY291bnQocykgIgogICAgICAgICAgICAgICAgICAgICAgZiJcbioqe2RlbF9hfSoqIGRlbGV0ZWQgYWRtaW4gYWNjb3VudHMgYXJlIG5vdCByZW1vdmVkIgogICAgICAgICAgICAgICAgICAgICAgKQogICAgYXdhaXQgc2hvdy5lZGl0KGRlbF9zdGF0dXMpCiAgICBhd2FpdCBzbGVlcCgyKQogICAgYXdhaXQgc2hvdy5kZWxldGUoKQoKICAgIGlmIEJPVExPRzoKICAgICAgICBhd2FpdCBzaG93LmNsaWVudC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIEJPVExPR19DSEFUSUQsICIjQ0xFQU5VUFxuIgogICAgICAgICAgICBmIkNsZWFuZWQgKip7ZGVsX3V9KiogZGVsZXRlZCBhY2NvdW50KHMpICEhIgogICAgICAgICAgICBmIlxuQ0hBVDoge3Nob3cuY2hhdC50aXRsZX0oYHtzaG93LmNoYXRfaWR9YCkiKQoKCkByZWdpc3RlcihvdXRnb2luZz1UcnVlLCBwYXR0ZXJuPXIiXlwuYWxsJCIpCmFzeW5jIGRlZiB0YWdhc28oZXZlbnQpOgogICAgIiIiIEZvciAuYWxsIGNvbW1hbmQsIG1lbnRpb24gYWxsIG9mIHRoZSBtZW1iZXIgaW4gdGhlIGdyb3VwIGNoYXQiIiIKICAgIGlmIGV2ZW50LmZ3ZF9mcm9tOgogICAgICAgIHJldHVybgogICAgYXdhaXQgZXZlbnQuZGVsZXRlKCkKICAgIG1lbnRpb25zID0gIkBhbGwiCiAgICBjaGF0ID0gYXdhaXQgZXZlbnQuZ2V0X2lucHV0X2NoYXQoKQogICAgYXN5bmMgZm9yIHVzZXIgaW4gYm90Lml0ZXJfcGFydGljaXBhbnRzKGNoYXQsIDUwMCk6CiAgICAgICAgbWVudGlvbnMgKz0gZiJbXHUyMDYzXSh0ZzovL3VzZXI/aWQ9e3VzZXIuaWR9KSIKICAgIGF3YWl0IGJvdC5zZW5kX21lc3NhZ2UoCiAgICAgICAgY2hhdCwgbWVudGlvbnMsIHJlcGx5X3RvPWV2ZW50Lm1lc3NhZ2UucmVwbHlfdG9fbXNnX2lkKQoKCkByZWdpc3RlcihvdXRnb2luZz1UcnVlLCBwYXR0ZXJuPXIiXlwuYWRtaW5zJCIpCmFzeW5jIGRlZiBnZXRfYWRtaW4oc2hvdyk6CiAgICAiIiIgRm9yIC5hZG1pbnMgY29tbWFuZCwgbGlzdCBhbGwgb2YgdGhlIGFkbWlucyBvZiB0aGUgY2hhdC4gIiIiCiAgICBpbmZvID0gYXdhaXQgc2hvdy5jbGllbnQuZ2V0X2VudGl0eShzaG93LmNoYXRfaWQpCiAgICB0aXRsZSA9IGluZm8udGl0bGUgaWYgaW5mby50aXRsZSBlbHNlICJ0aGlzIGNoYXQiCiAgICBtZW50aW9ucyA9IGYnPGI+QWRtaW5zIGluIHt0aXRsZX06PC9iPiBcbicKICAgIHRyeToKICAgICAgICBhc3luYyBmb3IgdXNlciBpbiBzaG93LmNsaWVudC5pdGVyX3BhcnRpY2lwYW50cygKICAgICAgICAgICAgICAgIHNob3cuY2hhdF9pZCwgZmlsdGVyPUNoYW5uZWxQYXJ0aWNpcGFudHNBZG1pbnMpOgogICAgICAgICAgICBpZiBub3QgdXNlci5kZWxldGVkOgogICAgICAgICAgICAgICAgbGluayA9IGYiPGEgaHJlZj1cInRnOi8vdXNlcj9pZD17dXNlci5pZH1cIj57dXNlci5maXJzdF9uYW1lfTwvYT4iCiAgICAgICAgICAgICAgICBtZW50aW9ucyArPSBmIlxue2xpbmt9IgogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgbWVudGlvbnMgKz0gZiJcbkRlbGV0ZWQgQWNjb3VudCA8Y29kZT57dXNlci5pZH08L2NvZGU+IgogICAgZXhjZXB0IENoYXRBZG1pblJlcXVpcmVkRXJyb3IgYXMgZXJyOgogICAgICAgIG1lbnRpb25zICs9ICIgIiArIHN0cihlcnIpICsgIlxuIgogICAgYXdhaXQgc2hvdy5lZGl0KG1lbnRpb25zLCBwYXJzZV9tb2RlPSJodG1sIikKCgpAcmVnaXN0ZXIob3V0Z29pbmc9VHJ1ZSwgcGF0dGVybj1yIl5cLnBpbig/OiB8JCkoLiopIikKYXN5bmMgZGVmIHBpbihtc2cpOgogICAgIiIiIEZvciAucGluIGNvbW1hbmQsIHBpbnMgdGhlIHJlcGxpZWQvdGFnZ2VkIG1lc3NhZ2Ugb24gdGhlIHRvcCB0aGUgY2hhdC4gIiIiCiAgICAjIEFkbWluIG9yIGNyZWF0b3IgY2hlY2sKICAgIGNoYXQgPSBhd2FpdCBtc2cuZ2V0X2NoYXQoKQogICAgYWRtaW4gPSBjaGF0LmFkbWluX3JpZ2h0cwogICAgY3JlYXRvciA9IGNoYXQuY3JlYXRvcgoKICAgICMgSWYgbm90IGFkbWluIGFuZCBub3QgY3JlYXRvciwgcmV0dXJuCiAgICBpZiBub3QgYWRtaW4gYW5kIG5vdCBjcmVhdG9yOgogICAgICAgIHJldHVybiBhd2FpdCBtc2cuZWRpdChOT19BRE1JTikKCiAgICB0b19waW4gPSBtc2cucmVwbHlfdG9fbXNnX2lkCgogICAgaWYgbm90IHRvX3BpbjoKICAgICAgICByZXR1cm4gYXdhaXQgbXNnLmVkaXQoImBSZXBseSB0byBhIG1lc3NhZ2UgdG8gcGluIGl0LmAiKQoKICAgIG9wdGlvbnMgPSBtc2cucGF0dGVybl9tYXRjaC5ncm91cCgxKQoKICAgIGlzX3NpbGVudCA9IFRydWUKCiAgICBpZiBvcHRpb25zLmxvd2VyKCkgPT0gImxvdWQiOgogICAgICAgIGlzX3NpbGVudCA9IEZhbHNlCgogICAgdHJ5OgogICAgICAgIGF3YWl0IG1zZy5jbGllbnQoCiAgICAgICAgICAgIFVwZGF0ZVBpbm5lZE1lc3NhZ2VSZXF1ZXN0KG1zZy50b19pZCwgdG9fcGluLCBpc19zaWxlbnQpKQogICAgZXhjZXB0IEJhZFJlcXVlc3RFcnJvcjoKICAgICAgICByZXR1cm4gYXdhaXQgbXNnLmVkaXQoTk9fUEVSTSkKCiAgICBhd2FpdCBtc2cuZWRpdCgiYFBpbm5lZCBTdWNjZXNzZnVsbHkhYCIpCgogICAgdXNlciA9IGF3YWl0IGdldF91c2VyX2Zyb21faWQobXNnLmZyb21faWQsIG1zZykKCiAgICBpZiBCT1RMT0c6CiAgICAgICAgYXdhaXQgbXNnLmNsaWVudC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIEJPVExPR19DSEFUSUQsICIjUElOXG4iCiAgICAgICAgICAgIGYiQURNSU46IFt7dXNlci5maXJzdF9uYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyLmlkfSlcbiIKICAgICAgICAgICAgZiJDSEFUOiB7bXNnLmNoYXQudGl0bGV9KGB7bXNnLmNoYXRfaWR9YClcbiIKICAgICAgICAgICAgZiJMT1VEOiB7bm90IGlzX3NpbGVudH0iKQoKCkByZWdpc3RlcihvdXRnb2luZz1UcnVlLCBwYXR0ZXJuPXIiXlwua2ljayg/OiB8JCkoLiopIikKYXN5bmMgZGVmIGtpY2sodXNyKToKICAgICIiIiBGb3IgLmtpY2sgY29tbWFuZCwga2lja3MgdGhlIHJlcGxpZWQvdGFnZ2VkIHBlcnNvbiBmcm9tIHRoZSBncm91cC4gIiIiCiAgICAjIEFkbWluIG9yIGNyZWF0b3IgY2hlY2sKICAgIGNoYXQgPSBhd2FpdCB1c3IuZ2V0X2NoYXQoKQogICAgYWRtaW4gPSBjaGF0LmFkbWluX3JpZ2h0cwogICAgY3JlYXRvciA9IGNoYXQuY3JlYXRvcgoKICAgICMgSWYgbm90IGFkbWluIGFuZCBub3QgY3JlYXRvciwgcmV0dXJuCiAgICBpZiBub3QgYWRtaW4gYW5kIG5vdCBjcmVhdG9yOgogICAgICAgIHJldHVybiBhd2FpdCB1c3IuZWRpdChOT19BRE1JTikKCiAgICB1c2VyLCByZWFzb24gPSBhd2FpdCBnZXRfdXNlcl9mcm9tX2V2ZW50KHVzcikKICAgIGlmIG5vdCB1c2VyOgogICAgICAgIHJldHVybiBhd2FpdCB1c3IuZWRpdCgiYENvdWxkbid0IGZldGNoIHVzZXIuYCIpCgogICAgYXdhaXQgdXNyLmVkaXQoImBLaWNraW5nLi4uYCIpCgogICAgdHJ5OgogICAgICAgIGF3YWl0IHVzci5jbGllbnQua2lja19wYXJ0aWNpcGFudCh1c3IuY2hhdF9pZCwgdXNlci5pZCkKICAgICAgICBhd2FpdCBzbGVlcCguNSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICByZXR1cm4gYXdhaXQgdXNyLmVkaXQoTk9fUEVSTSArIGYiXG57c3RyKGUpfSIpCgogICAgaWYgcmVhc29uOgogICAgICAgIGF3YWl0IHVzci5lZGl0KAogICAgICAgICAgICBmImBLaWNrZWRgIFt7dXNlci5maXJzdF9uYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyLmlkfSlgIWBcblJlYXNvbjoge3JlYXNvbn0iCiAgICAgICAgKQogICAgZWxzZToKICAgICAgICBhd2FpdCB1c3IuZWRpdCgKICAgICAgICAgICAgZiJgS2lja2VkYCBbe3VzZXIuZmlyc3RfbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlci5pZH0pYCFgIikKCiAgICBpZiBCT1RMT0c6CiAgICAgICAgYXdhaXQgdXNyLmNsaWVudC5zZW5kX21lc3NhZ2UoCiAgICAgICAgICAgIEJPVExPR19DSEFUSUQsICIjS0lDS1xuIgogICAgICAgICAgICBmIlVTRVI6IFt7dXNlci5maXJzdF9uYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyLmlkfSlcbiIKICAgICAgICAgICAgZiJDSEFUOiB7dXNyLmNoYXQudGl0bGV9KGB7dXNyLmNoYXRfaWR9YClcbiIpCgoKQHJlZ2lzdGVyKG91dGdvaW5nPVRydWUsIHBhdHRlcm49ciJeXC51c2VycyA/KC4qKSIpCmFzeW5jIGRlZiBnZXRfdXNlcnMoc2hvdyk6CiAgICAiIiIgRm9yIC51c2VycyBjb21tYW5kLCBsaXN0IGFsbCBvZiB0aGUgdXNlcnMgaW4gYSBjaGF0LiAiIiIKICAgIGluZm8gPSBhd2FpdCBzaG93LmNsaWVudC5nZXRfZW50aXR5KHNob3cuY2hhdF9pZCkKICAgIHRpdGxlID0gaW5mby50aXRsZSBpZiBpbmZvLnRpdGxlIGVsc2UgInRoaXMgY2hhdCIKICAgIG1lbnRpb25zID0gJ1VzZXJzIGluIHt9OiBcbicuZm9ybWF0KHRpdGxlKQogICAgdHJ5OgogICAgICAgIGlmIG5vdCBzaG93LnBhdHRlcm5fbWF0Y2guZ3JvdXAoMSk6CiAgICAgICAgICAgIGFzeW5jIGZvciB1c2VyIGluIHNob3cuY2xpZW50Lml0ZXJfcGFydGljaXBhbnRzKHNob3cuY2hhdF9pZCk6CiAgICAgICAgICAgICAgICBpZiBub3QgdXNlci5kZWxldGVkOgogICAgICAgICAgICAgICAgICAgIG1lbnRpb25zICs9IGYiXG5be3VzZXIuZmlyc3RfbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlci5pZH0pIGB7dXNlci5pZH1gIgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBtZW50aW9ucyArPSBmIlxuRGVsZXRlZCBBY2NvdW50IGB7dXNlci5pZH1gIgogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHNlYXJjaHEgPSBzaG93LnBhdHRlcm5fbWF0Y2guZ3JvdXAoMSkKICAgICAgICAgICAgYXN5bmMgZm9yIHVzZXIgaW4gc2hvdy5jbGllbnQuaXRlcl9wYXJ0aWNpcGFudHMoCiAgICAgICAgICAgICAgICAgICAgc2hvdy5jaGF0X2lkLCBzZWFyY2g9Zid7c2VhcmNocX0nKToKICAgICAgICAgICAgICAgIGlmIG5vdCB1c2VyLmRlbGV0ZWQ6CiAgICAgICAgICAgICAgICAgICAgbWVudGlvbnMgKz0gZiJcblt7dXNlci5maXJzdF9uYW1lfV0odGc6Ly91c2VyP2lkPXt1c2VyLmlkfSkgYHt1c2VyLmlkfWAiCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIG1lbnRpb25zICs9IGYiXG5EZWxldGVkIEFjY291bnQgYHt1c2VyLmlkfWAiCiAgICBleGNlcHQgQ2hhdEFkbWluUmVxdWlyZWRFcnJvciBhcyBlcnI6CiAgICAgICAgbWVudGlvbnMgKz0gIiAiICsgc3RyKGVycikgKyAiXG4iCiAgICB0cnk6CiAgICAgICAgYXdhaXQgc2hvdy5lZGl0KG1lbnRpb25zKQogICAgZXhjZXB0IE1lc3NhZ2VUb29Mb25nRXJyb3I6CiAgICAgICAgYXdhaXQgc2hvdy5lZGl0KAogICAgICAgICAgICAiRGFtbiwgdGhpcyBpcyBhIGh1Z2UgZ3JvdXAuIFVwbG9hZGluZyB1c2VycyBsaXN0cyBhcyBmaWxlLiIpCiAgICAgICAgZmlsZSA9IG9wZW4oInVzZXJzbGlzdC50eHQiLCAidysiKQogICAgICAgIGZpbGUud3JpdGUobWVudGlvbnMpCiAgICAgICAgZmlsZS5jbG9zZSgpCiAgICAgICAgYXdhaXQgc2hvdy5jbGllbnQuc2VuZF9maWxlKAogICAgICAgICAgICBzaG93LmNoYXRfaWQsCiAgICAgICAgICAgICJ1c2Vyc2xpc3QudHh0IiwKICAgICAgICAgICAgY2FwdGlvbj0nVXNlcnMgaW4ge30nLmZvcm1hdCh0aXRsZSksCiAgICAgICAgICAgIHJlcGx5X3RvPXNob3cuaWQsCiAgICAgICAgKQogICAgICAgIHJlbW92ZSgidXNlcnNsaXN0LnR4dCIpCgoKYXN5bmMgZGVmIGdldF91c2VyX2Zyb21fZXZlbnQoZXZlbnQpOgogICAgIiIiIEdldCB0aGUgdXNlciBmcm9tIGFyZ3VtZW50IG9yIHJlcGxpZWQgbWVzc2FnZS4gIiIiCiAgICBhcmdzID0gZXZlbnQucGF0dGVybl9tYXRjaC5ncm91cCgxKS5zcGxpdCgnICcsIDEpCiAgICBleHRyYSA9IE5vbmUKICAgIGlmIGV2ZW50LnJlcGx5X3RvX21zZ19pZCBhbmQgbm90IGxlbihhcmdzKSA9PSAyOgogICAgICAgIHByZXZpb3VzX21lc3NhZ2UgPSBhd2FpdCBldmVudC5nZXRfcmVwbHlfbWVzc2FnZSgpCiAgICAgICAgdXNlcl9vYmogPSBhd2FpdCBldmVudC5jbGllbnQuZ2V0X2VudGl0eShwcmV2aW91c19tZXNzYWdlLmZyb21faWQpCiAgICAgICAgZXh0cmEgPSBldmVudC5wYXR0ZXJuX21hdGNoLmdyb3VwKDEpCiAgICBlbGlmIGFyZ3M6CiAgICAgICAgdXNlciA9IGFyZ3NbMF0KICAgICAgICBpZiBsZW4oYXJncykgPT0gMjoKICAgICAgICAgICAgZXh0cmEgPSBhcmdzWzFdCgogICAgICAgIGlmIHVzZXIuaXNudW1lcmljKCk6CiAgICAgICAgICAgIHVzZXIgPSBpbnQodXNlcikKCiAgICAgICAgaWYgbm90IHVzZXI6CiAgICAgICAgICAgIHJldHVybiBhd2FpdCBldmVudC5lZGl0KCJgUGFzcyB0aGUgdXNlcidzIHVzZXJuYW1lLCBpZCBvciByZXBseSFgIikKCiAgICAgICAgaWYgZXZlbnQubWVzc2FnZS5lbnRpdGllcyBpcyBub3QgTm9uZToKICAgICAgICAgICAgcHJvYmFibGVfdXNlcl9tZW50aW9uX2VudGl0eSA9IGV2ZW50Lm1lc3NhZ2UuZW50aXRpZXNbMF0KCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocHJvYmFibGVfdXNlcl9tZW50aW9uX2VudGl0eSwKICAgICAgICAgICAgICAgICAgICAgICAgICBNZXNzYWdlRW50aXR5TWVudGlvbk5hbWUpOgogICAgICAgICAgICAgICAgdXNlcl9pZCA9IHByb2JhYmxlX3VzZXJfbWVudGlvbl9lbnRpdHkudXNlcl9pZAogICAgICAgICAgICAgICAgdXNlcl9vYmogPSBhd2FpdCBldmVudC5jbGllbnQuZ2V0X2VudGl0eSh1c2VyX2lkKQogICAgICAgICAgICAgICAgcmV0dXJuIHVzZXJfb2JqCiAgICAgICAgdHJ5OgogICAgICAgICAgICB1c2VyX29iaiA9IGF3YWl0IGV2ZW50LmNsaWVudC5nZXRfZW50aXR5KHVzZXIpCiAgICAgICAgZXhjZXB0IChUeXBlRXJyb3IsIFZhbHVlRXJyb3IpIGFzIGVycjoKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IGV2ZW50LmVkaXQoc3RyKGVycikpCgogICAgcmV0dXJuIHVzZXJfb2JqLCBleHRyYQoKCmFzeW5jIGRlZiBnZXRfdXNlcl9mcm9tX2lkKHVzZXIsIGV2ZW50KToKICAgIGlmIGlzaW5zdGFuY2UodXNlciwgc3RyKToKICAgICAgICB1c2VyID0gaW50KHVzZXIpCgogICAgdHJ5OgogICAgICAgIHVzZXJfb2JqID0gYXdhaXQgZXZlbnQuY2xpZW50LmdldF9lbnRpdHkodXNlcikKICAgIGV4Y2VwdCAoVHlwZUVycm9yLCBWYWx1ZUVycm9yKSBhcyBlcnI6CiAgICAgICAgcmV0dXJuIGF3YWl0IGV2ZW50LmVkaXQoc3RyKGVycikpCgogICAgcmV0dXJuIHVzZXJfb2JqCgoKQHJlZ2lzdGVyKG91dGdvaW5nPVRydWUsIHBhdHRlcm49ciJeXC51c2Vyc2RlbCA/KC4qKSIpCmFzeW5jIGRlZiBnZXRfdXNlcnNkZWwoc2hvdyk6CiAgICAiIiIgRm9yIC51c2Vyc2RlbCBjb21tYW5kLCBsaXN0IGFsbCBvZiB0aGUgZGVsZXRlZCB1c2VycyBpbiBhIGNoYXQuICIiIgogICAgaW5mbyA9IGF3YWl0IHNob3cuY2xpZW50LmdldF9lbnRpdHkoc2hvdy5jaGF0X2lkKQogICAgdGl0bGUgPSBpbmZvLnRpdGxlIGlmIGluZm8udGl0bGUgZWxzZSAidGhpcyBjaGF0IgogICAgbWVudGlvbnMgPSAnZGVsZXRlZFVzZXJzIGluIHt9OiBcbicuZm9ybWF0KHRpdGxlKQogICAgdHJ5OgogICAgICAgIGlmIG5vdCBzaG93LnBhdHRlcm5fbWF0Y2guZ3JvdXAoMSk6CiAgICAgICAgICAgIGFzeW5jIGZvciB1c2VyIGluIHNob3cuY2xpZW50Lml0ZXJfcGFydGljaXBhbnRzKHNob3cuY2hhdF9pZCk6CiAgICAgICAgICAgICAgICBpZiBub3QgdXNlci5kZWxldGVkOgogICAgICAgICAgICAgICAgICAgIG1lbnRpb25zICs9IGYiXG5be3VzZXIuZmlyc3RfbmFtZX1dKHRnOi8vdXNlcj9pZD17dXNlci5pZH0pIGB7dXNlci5pZH1gIgogICAgICAgICAjICAgICAgIGVsc2U6CiAgICAjICAgICAgICAgICAgICAgIG1lbnRpb25zICs9IGYiXG5EZWxldGVkIEFjY291bnQgYHt1c2VyLmlkfWAiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VhcmNocSA9IHNob3cucGF0dGVybl9tYXRjaC5ncm91cCgxKQogICAgICAgICAgICBhc3luYyBmb3IgdXNlciBpbiBzaG93LmNsaWVudC5pdGVyX3BhcnRpY2lwYW50cygKICAgICAgICAgICAgICAgICAgICBzaG93LmNoYXRfaWQsIHNlYXJjaD1mJ3tzZWFyY2hxfScpOgogICAgICAgICAgICAgICAgaWYgbm90IHVzZXIuZGVsZXRlZDoKICAgICAgICAgICAgICAgICAgICBtZW50aW9ucyArPSBmIlxuW3t1c2VyLmZpcnN0X25hbWV9XSh0ZzovL3VzZXI/aWQ9e3VzZXIuaWR9KSBge3VzZXIuaWR9YCIKICAgICAgICAgIyAgICAgICBlbHNlOgogICAgICAjICAgICAgICAgICAgICBtZW50aW9ucyArPSBmIlxuRGVsZXRlZCBBY2NvdW50IGB7dXNlci5pZH1gIgogICAgZXhjZXB0IENoYXRBZG1pblJlcXVpcmVkRXJyb3IgYXMgZXJyOgogICAgICAgIG1lbnRpb25zICs9ICIgIiArIHN0cihlcnIpICsgIlxuIgogICAgdHJ5OgogICAgICAgIGF3YWl0IHNob3cuZWRpdChtZW50aW9ucykKICAgIGV4Y2VwdCBNZXNzYWdlVG9vTG9uZ0Vycm9yOgogICAgICAgIGF3YWl0IHNob3cuZWRpdCgKICAgICAgICAgICAgIkRhbW4sIHRoaXMgaXMgYSBodWdlIGdyb3VwLiBVcGxvYWRpbmcgZGVsZXRlZHVzZXJzIGxpc3RzIGFzIGZpbGUuIikKICAgICAgICBmaWxlID0gb3BlbigidXNlcnNsaXN0LnR4dCIsICJ3KyIpCiAgICAgICAgZmlsZS53cml0ZShtZW50aW9ucykKICAgICAgICBmaWxlLmNsb3NlKCkKICAgICAgICBhd2FpdCBzaG93LmNsaWVudC5zZW5kX2ZpbGUoCiAgICAgICAgICAgIHNob3cuY2hhdF9pZCwKICAgICAgICAgICAgImRlbGV0ZWR1c2Vyc2xpc3QudHh0IiwKICAgICAgICAgICAgY2FwdGlvbj0nVXNlcnMgaW4ge30nLmZvcm1hdCh0aXRsZSksCiAgICAgICAgICAgIHJlcGx5X3RvPXNob3cuaWQsCiAgICAgICAgKQogICAgICAgIHJlbW92ZSgiZGVsZXRlZHVzZXJzbGlzdC50eHQiKQoKCmFzeW5jIGRlZiBnZXRfdXNlcmRlbF9mcm9tX2V2ZW50KGV2ZW50KToKICAgICIiIiBHZXQgdGhlIGRlbGV0ZWQgdXNlciBmcm9tIGFyZ3VtZW50IG9yIHJlcGxpZWQgbWVzc2FnZS4gIiIiCiAgICBhcmdzID0gZXZlbnQucGF0dGVybl9tYXRjaC5ncm91cCgxKS5zcGxpdCgnICcsIDEpCiAgICBleHRyYSA9IE5vbmUKICAgIGlmIGV2ZW50LnJlcGx5X3RvX21zZ19pZCBhbmQgbm90IGxlbihhcmdzKSA9PSAyOgogICAgICAgIHByZXZpb3VzX21lc3NhZ2UgPSBhd2FpdCBldmVudC5nZXRfcmVwbHlfbWVzc2FnZSgpCiAgICAgICAgdXNlcl9vYmogPSBhd2FpdCBldmVudC5jbGllbnQuZ2V0X2VudGl0eShwcmV2aW91c19tZXNzYWdlLmZyb21faWQpCiAgICAgICAgZXh0cmEgPSBldmVudC5wYXR0ZXJuX21hdGNoLmdyb3VwKDEpCiAgICBlbGlmIGFyZ3M6CiAgICAgICAgdXNlciA9IGFyZ3NbMF0KICAgICAgICBpZiBsZW4oYXJncykgPT0gMjoKICAgICAgICAgICAgZXh0cmEgPSBhcmdzWzFdCgogICAgICAgIGlmIHVzZXIuaXNudW1lcmljKCk6CiAgICAgICAgICAgIHVzZXIgPSBpbnQodXNlcikKCiAgICAgICAgaWYgbm90IHVzZXI6CiAgICAgICAgICAgIHJldHVybiBhd2FpdCBldmVudC5lZGl0KCJgUGFzcyB0aGUgZGVsZXRlZCB1c2VyJ3MgdXNlcm5hbWUsIGlkIG9yIHJlcGx5IWAiKQoKICAgICAgICBpZiBldmVudC5tZXNzYWdlLmVudGl0aWVzIGlzIG5vdCBOb25lOgogICAgICAgICAgICBwcm9iYWJsZV91c2VyX21lbnRpb25fZW50aXR5ID0gZXZlbnQubWVzc2FnZS5lbnRpdGllc1swXQoKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwcm9iYWJsZV91c2VyX21lbnRpb25fZW50aXR5LAogICAgICAgICAgICAgICAgICAgICAgICAgIE1lc3NhZ2VFbnRpdHlNZW50aW9uTmFtZSk6CiAgICAgICAgICAgICAgICB1c2VyX2lkID0gcHJvYmFibGVfdXNlcl9tZW50aW9uX2VudGl0eS51c2VyX2lkCiAgICAgICAgICAgICAgICB1c2VyX29iaiA9IGF3YWl0IGV2ZW50LmNsaWVudC5nZXRfZW50aXR5KHVzZXJfaWQpCiAgICAgICAgICAgICAgICByZXR1cm4gdXNlcl9vYmoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHVzZXJfb2JqID0gYXdhaXQgZXZlbnQuY2xpZW50LmdldF9lbnRpdHkodXNlcikKICAgICAgICBleGNlcHQgKFR5cGVFcnJvciwgVmFsdWVFcnJvcikgYXMgZXJyOgogICAgICAgICAgICByZXR1cm4gYXdhaXQgZXZlbnQuZWRpdChzdHIoZXJyKSkKCiAgICByZXR1cm4gdXNlcl9vYmosIGV4dHJhCgoKYXN5bmMgZGVmIGdldF91c2VyZGVsX2Zyb21faWQodXNlciwgZXZlbnQpOgogICAgaWYgaXNpbnN0YW5jZSh1c2VyLCBzdHIpOgogICAgICAgIHVzZXIgPSBpbnQodXNlcikKCiAgICB0cnk6CiAgICAgICAgdXNlcl9vYmogPSBhd2FpdCBldmVudC5jbGllbnQuZ2V0X2VudGl0eSh1c2VyKQogICAgZXhjZXB0IChUeXBlRXJyb3IsIFZhbHVlRXJyb3IpIGFzIGVycjoKICAgICAgICByZXR1cm4gYXdhaXQgZXZlbnQuZWRpdChzdHIoZXJyKSkKCiAgICByZXR1cm4gdXNlcl9vYmoKCgpAcmVnaXN0ZXIob3V0Z29pbmc9VHJ1ZSwgcGF0dGVybj1yIl5cLmJvdHMkIiwgZ3JvdXBzX29ubHk9VHJ1ZSkKYXN5bmMgZGVmIGdldF9ib3RzKHNob3cpOgogICAgIiIiIEZvciAuYm90cyBjb21tYW5kLCBsaXN0IGFsbCBvZiB0aGUgYm90cyBvZiB0aGUgY2hhdC4gIiIiCiAgICBpbmZvID0gYXdhaXQgc2hvdy5jbGllbnQuZ2V0X2VudGl0eShzaG93LmNoYXRfaWQpCiAgICB0aXRsZSA9IGluZm8udGl0bGUgaWYgaW5mby50aXRsZSBlbHNlICJ0aGlzIGNoYXQiCiAgICBtZW50aW9ucyA9IGYnPGI+Qm90cyBpbiB7dGl0bGV9OjwvYj5cbicKICAgIHRyeToKICAgICAgICBpZiBpc2luc3RhbmNlKHNob3cudG9faWQsIFBlZXJDaGF0KToKICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHNob3cuZWRpdCgiYEkgaGVhcmQgdGhhdCBvbmx5IFN1cGVyZ3JvdXBzIGNhbiBoYXZlIGJvdHMuYCIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXN5bmMgZm9yIHVzZXIgaW4gc2hvdy5jbGllbnQuaXRlcl9wYXJ0aWNpcGFudHMoCiAgICAgICAgICAgICAgICAgICAgc2hvdy5jaGF0X2lkLCBmaWx0ZXI9Q2hhbm5lbFBhcnRpY2lwYW50c0JvdHMpOgogICAgICAgICAgICAgICAgaWYgbm90IHVzZXIuZGVsZXRlZDoKICAgICAgICAgICAgICAgICAgICBsaW5rID0gZiI8YSBocmVmPVwidGc6Ly91c2VyP2lkPXt1c2VyLmlkfVwiPnt1c2VyLmZpcnN0X25hbWV9PC9hPiIKICAgICAgICAgICAgICAgICAgICB1c2VyaWQgPSBmIjxjb2RlPnt1c2VyLmlkfTwvY29kZT4iCiAgICAgICAgICAgICAgICAgICAgbWVudGlvbnMgKz0gZiJcbntsaW5rfSB7dXNlcmlkfSIKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgbWVudGlvbnMgKz0gZiJcbkRlbGV0ZWQgQm90IDxjb2RlPnt1c2VyLmlkfTwvY29kZT4iCiAgICBleGNlcHQgQ2hhdEFkbWluUmVxdWlyZWRFcnJvciBhcyBlcnI6CiAgICAgICAgbWVudGlvbnMgKz0gIiAiICsgc3RyKGVycikgKyAiXG4iCiAgICB0cnk6CiAgICAgICAgYXdhaXQgc2hvdy5lZGl0KG1lbnRpb25zLCBwYXJzZV9tb2RlPSJodG1sIikKICAgIGV4Y2VwdCBNZXNzYWdlVG9vTG9uZ0Vycm9yOgogICAgICAgIGF3YWl0IHNob3cuZWRpdCgKICAgICAgICAgICAgIkRhbW4sIHRvbyBtYW55IGJvdHMgaGVyZS4gVXBsb2FkaW5nIGJvdHMgbGlzdCBhcyBmaWxlLiIpCiAgICAgICAgZmlsZSA9IG9wZW4oImJvdGxpc3QudHh0IiwgIncrIikKICAgICAgICBmaWxlLndyaXRlKG1lbnRpb25zKQogICAgICAgIGZpbGUuY2xvc2UoKQogICAgICAgIGF3YWl0IHNob3cuY2xpZW50LnNlbmRfZmlsZSgKICAgICAgICAgICAgc2hvdy5jaGF0X2lkLAogICAgICAgICAgICAiYm90bGlzdC50eHQiLAogICAgICAgICAgICBjYXB0aW9uPSdCb3RzIGluIHt9Jy5mb3JtYXQodGl0bGUpLAogICAgICAgICAgICByZXBseV90bz1zaG93LmlkLAogICAgICAgICkKICAgICAgICByZW1vdmUoImJvdGxpc3QudHh0IikKCgpDTURfSEVMUC51cGRhdGUoCiAgICB7CiAgICAgICAgImFkbWluIjogIj5gLnByb21vdGUgPHVzZXJuYW1lL3JlcGx5PiA8Y3VzdG9tIHJhbmsgKG9wdGlvbmFsKT5gIgogICAgICAgICJcblVzYWdlOiBQcm92aWRlcyBhZG1pbiByaWdodHMgdG8gdGhlIHBlcnNvbiBpbiB0aGUgY2hhdC4iCiAgICAgICAgIlxuXG4+YC5kZW1vdGUgPHVzZXJuYW1lL3JlcGx5PmAiCiAgICAgICAgIlxuVXNhZ2U6IFJldm9rZXMgdGhlIHBlcnNvbidzIGFkbWluIHBlcm1pc3Npb25zIGluIHRoZSBjaGF0LiIKICAgICAgICAiXG5cbj5gLmJhbiA8dXNlcm5hbWUvcmVwbHk+IDxyZWFzb24gKG9wdGlvbmFsKT5gIgogICAgICAgICJcblVzYWdlOiBCYW5zIHRoZSBwZXJzb24gb2ZmIHlvdXIgY2hhdC4iCiAgICAgICAgIlxuXG4+YC51bmJhbiA8dXNlcm5hbWUvcmVwbHk+YCIKICAgICAgICAiXG5Vc2FnZTogUmVtb3ZlcyB0aGUgYmFuIGZyb20gdGhlIHBlcnNvbiBpbiB0aGUgY2hhdC4iCiAgICAgICAgIlxuXG4+YC5tdXRlIDx1c2VybmFtZS9yZXBseT4gPHJlYXNvbiAob3B0aW9uYWwpPmAiCiAgICAgICAgIlxuVXNhZ2U6IE11dGVzIHRoZSBwZXJzb24gaW4gdGhlIGNoYXQsIHdvcmtzIG9uIGFkbWlucyB0b28uIgogICAgICAgICJcblxuPmAudW5tdXRlIDx1c2VybmFtZS9yZXBseT5gIgogICAgICAgICJcblVzYWdlOiBSZW1vdmVzIHRoZSBwZXJzb24gZnJvbSB0aGUgbXV0ZWQgbGlzdC4iCiAgICAgICAgIlxuXG4+YC5nbXV0ZWAgPHVzZXJuYW1lL3JlcGx5PiA8cmVhc29uIChvcHRpb25hbCk+IgogICAgICAgICJcblVzYWdlOiBNdXRlcyB0aGUgcGVyc29uIGluIGFsbCBncm91cHMgeW91IGhhdmUgaW4gY29tbW9uIHdpdGggdGhlbS4iCiAgICAgICAgIlxuXG4+YC51bmdtdXRlYCA8dXNlcm5hbWUvcmVwbHk+IgogICAgICAgICJcblVzYWdlOiBSZXBseSBzb21lb25lJ3MgbWVzc2FnZSB3aXRoIC51bmdtdXRlIHRvIHJlbW92ZSB0aGVtIGZyb20gdGhlIGdtdXRlZCBsaXN0LiIKICAgICAgICAiXG5cbj5gLnpvbWJpZXNgIgogICAgICAgICJcblVzYWdlOiBTZWFyY2hlcyBmb3IgZGVsZXRlZCBhY2NvdW50cyBpbiBhIGdyb3VwLiAiCiAgICAgICAgIlVzZSAuem9tYmllcyBjbGVhbiB0byByZW1vdmUgZGVsZXRlZCBhY2NvdW50cyBmcm9tIHRoZSBncm91cC4iCiAgICAgICAgIlxuXG4+YC5hbGxgIgogICAgICAgICJcblVzYWdlOiBUYWcgYWxsIG1lbWJlciBpbiB0aGUgZ3JvdXAgY2hhdC4iCiAgICAgICAgIlxuXG4+YC5hZG1pbnNgIgogICAgICAgICJcblVzYWdlOiBSZXRyaWV2ZXMgYSBsaXN0IG9mIGFkbWlucyBpbiB0aGUgY2hhdC4iCiAgICAgICAgIlxuXG4+YC5ib3RzYCIKICAgICAgICAiXG5Vc2FnZTogUmV0cmlldmVzIGEgbGlzdCBvZiBib3RzIGluIHRoZSBjaGF0LiIKICAgICAgICAiXG5cbj5gLnVzZXJzYCBvciA+YC51c2VycyA8bmFtZSBvZiBtZW1iZXI+YCIKICAgICAgICAiXG5Vc2FnZTogUmV0cmlldmVzIGFsbCAob3IgcXVlcmllZCkgdXNlcnMgaW4gdGhlIGNoYXQuIgogICAgICAgICJcblxuPmAuc2V0Z3BwaWMgPHJlcGx5IHRvIGltYWdlPmAiCiAgICAgICAgIlxuVXNhZ2U6IENoYW5nZXMgdGhlIGdyb3VwJ3MgZGlzcGxheSBwaWN0dXJlLiJ9KQo='))
